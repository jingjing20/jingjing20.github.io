<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 17 新特性 | 婧婧前端记录</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/jingjing.jpg">
    <meta name="description" content="婧婧的个人站点">
    
    <link rel="preload" href="/assets/css/0.styles.f70f464c.css" as="style"><link rel="preload" href="/assets/js/app.904810b9.js" as="script"><link rel="preload" href="/assets/js/2.4ed7a71f.js" as="script"><link rel="preload" href="/assets/js/23.a9c07bef.js" as="script"><link rel="prefetch" href="/assets/js/10.a82f5191.js"><link rel="prefetch" href="/assets/js/11.5bfea8e2.js"><link rel="prefetch" href="/assets/js/12.27923400.js"><link rel="prefetch" href="/assets/js/13.b609ef2f.js"><link rel="prefetch" href="/assets/js/14.14596749.js"><link rel="prefetch" href="/assets/js/15.7dc2f08f.js"><link rel="prefetch" href="/assets/js/16.1977d0be.js"><link rel="prefetch" href="/assets/js/17.27afb3c9.js"><link rel="prefetch" href="/assets/js/18.93a75ed3.js"><link rel="prefetch" href="/assets/js/19.20a8b75f.js"><link rel="prefetch" href="/assets/js/20.440df17a.js"><link rel="prefetch" href="/assets/js/21.48f47010.js"><link rel="prefetch" href="/assets/js/22.2a5f497e.js"><link rel="prefetch" href="/assets/js/24.eedba4e9.js"><link rel="prefetch" href="/assets/js/25.349cc1be.js"><link rel="prefetch" href="/assets/js/26.3fece767.js"><link rel="prefetch" href="/assets/js/27.560f00e5.js"><link rel="prefetch" href="/assets/js/28.f4c6a5ff.js"><link rel="prefetch" href="/assets/js/29.af3df93a.js"><link rel="prefetch" href="/assets/js/3.f2e4d2ce.js"><link rel="prefetch" href="/assets/js/30.5d533b48.js"><link rel="prefetch" href="/assets/js/31.d89c7bde.js"><link rel="prefetch" href="/assets/js/32.6e765835.js"><link rel="prefetch" href="/assets/js/33.68afa828.js"><link rel="prefetch" href="/assets/js/34.bf9239a9.js"><link rel="prefetch" href="/assets/js/35.0bab2e1b.js"><link rel="prefetch" href="/assets/js/36.4f60f7ef.js"><link rel="prefetch" href="/assets/js/37.377bd2c2.js"><link rel="prefetch" href="/assets/js/38.10ee46b9.js"><link rel="prefetch" href="/assets/js/39.004d09e7.js"><link rel="prefetch" href="/assets/js/4.93a1064c.js"><link rel="prefetch" href="/assets/js/40.9d15716b.js"><link rel="prefetch" href="/assets/js/41.5368e6d5.js"><link rel="prefetch" href="/assets/js/42.8040ef45.js"><link rel="prefetch" href="/assets/js/43.aba8177f.js"><link rel="prefetch" href="/assets/js/44.8df5d24b.js"><link rel="prefetch" href="/assets/js/45.8ac75652.js"><link rel="prefetch" href="/assets/js/46.57db489a.js"><link rel="prefetch" href="/assets/js/47.1d04810e.js"><link rel="prefetch" href="/assets/js/48.3f1d1bb7.js"><link rel="prefetch" href="/assets/js/49.33374fd1.js"><link rel="prefetch" href="/assets/js/5.3178f0b5.js"><link rel="prefetch" href="/assets/js/50.949a3e58.js"><link rel="prefetch" href="/assets/js/51.eec9f81e.js"><link rel="prefetch" href="/assets/js/52.6b07ecd7.js"><link rel="prefetch" href="/assets/js/53.1a8ab7da.js"><link rel="prefetch" href="/assets/js/54.c9ad4622.js"><link rel="prefetch" href="/assets/js/55.a412aa02.js"><link rel="prefetch" href="/assets/js/56.3c9d764d.js"><link rel="prefetch" href="/assets/js/57.a91270bd.js"><link rel="prefetch" href="/assets/js/58.9fc71bf9.js"><link rel="prefetch" href="/assets/js/59.78f08f27.js"><link rel="prefetch" href="/assets/js/6.f0484700.js"><link rel="prefetch" href="/assets/js/60.33d2e5f6.js"><link rel="prefetch" href="/assets/js/61.6080de0c.js"><link rel="prefetch" href="/assets/js/62.8dd37eb6.js"><link rel="prefetch" href="/assets/js/63.b69697cc.js"><link rel="prefetch" href="/assets/js/7.37f15cbe.js"><link rel="prefetch" href="/assets/js/8.a03d2eba.js"><link rel="prefetch" href="/assets/js/9.9bcc482f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f70f464c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/jingjing.jpg" alt="婧婧前端记录" class="logo"> <span class="site-name can-hide">婧婧前端记录</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/welcome/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/everyday/2020.html" class="nav-link">
  日常记录
</a></div><div class="nav-item"><a href="https://juejin.im/user/5d95a64ae51d4578200cc989" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jingjing20" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/welcome/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/everyday/2020.html" class="nav-link">
  日常记录
</a></div><div class="nav-item"><a href="https://juejin.im/user/5d95a64ae51d4578200cc989" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jingjing20" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript入门</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/React/jichu.html" class="sidebar-link">简单总结</a></li><li><a href="/React/setState.html" class="sidebar-link">setState 同步异步问题</a></li><li><a href="/React/react hooks.html" class="sidebar-link">React Hooks</a></li><li><a href="/React/React 17 新特性.html" class="active sidebar-link">React 17 新特性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/React/React 17 新特性.html#_1、更改事件委托" class="sidebar-link">1、更改事件委托</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/React/React 17 新特性.html#更新前" class="sidebar-link">更新前</a></li><li class="sidebar-sub-header"><a href="/React/React 17 新特性.html#更新原因" class="sidebar-link">更新原因</a></li><li class="sidebar-sub-header"><a href="/React/React 17 新特性.html#更新后" class="sidebar-link">更新后</a></li></ul></li><li class="sidebar-sub-header"><a href="/React/React 17 新特性.html#_2、去除了事件池" class="sidebar-link">2、去除了事件池</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/React/React 17 新特性.html#关于-react-中的合成事件的事件池" class="sidebar-link">关于 React 中的合成事件的事件池</a></li></ul></li><li class="sidebar-sub-header"><a href="/React/React 17 新特性.html#_3、useeffect-副作用清理时机的改动" class="sidebar-link">3、useEffect 副作用清理时机的改动</a></li><li class="sidebar-sub-header"><a href="/React/React 17 新特性.html#_4、全新的-jsx-转换规则" class="sidebar-link">4、全新的 JSX 转换规则</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/React/React 17 新特性.html#react-16-之前的转换规则" class="sidebar-link">React 16 之前的转换规则</a></li><li class="sidebar-sub-header"><a href="/React/React 17 新特性.html#react-17-的转换规则" class="sidebar-link">React 17 的转换规则</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>玩转Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>LeetCode</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1、更改事件委托"><a href="#_1、更改事件委托" class="header-anchor">#</a> 1、更改事件委托</h2> <h3 id="更新前"><a href="#更新前" class="header-anchor">#</a> 更新前</h3> <p>从技术上讲，始终可以在应用程序中嵌套不同版本的 React。但是，由于 <strong><em>React 事件系统的工作原理</em></strong>，这很难实现。</p> <ul><li>我们在 React 组件中写事件绑定一般会像如下实现：</li></ul> <div class="language-react line-numbers-mode"><pre class="language-text"><code>&lt;button onClick={handleClick}&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>对应的原生的 DOM 操作如下：</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>myButton<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> handleClick<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><p>但是 React 实际上并不会将它们绑定到 DOM 节点上。React 中是直接在 <code>document</code>节点上为每一种事件类型都附加一个处理器。这和我们所知的事件委托是一个意思。</p></li> <li><p>自从<code>React</code>发布以来，<code>React</code> 一直自动进行事件委托。当 <code>document</code> 上触发 <code>DOM</code> 事件时，<code>React</code> 会找出调用的组件，然后 <code>React</code> 事件会在组件中向上 “冒泡”。直到冒泡到了 <code>document</code> 上，React 在其中安装了事件处理器进行处理。</p></li></ul> <h3 id="更新原因"><a href="#更新原因" class="header-anchor">#</a> 更新原因</h3> <ul><li>React 一直以来遵循 <code>all-or-nothing</code> 的升级策略。你可以继续使用旧版本，也可以将整个应用程序升级至新版本。但没有介于两者之间的情况。就是不能渐进式更新，只能全量更新。</li> <li><code>React 17</code> 想实现渐进式更新，意思是页面上可以有不同版本的 <code>React</code>。这样原来<code>React</code>中的事件委托机制就会产生问题了。如果页面上有多个 React 版本，他们都将在顶层注册事件处理器。这会破坏 <code>e.stopPropagation()</code>：如果嵌套树结构中阻止了事件冒泡，但外部树依然能接收到它。这会使不同版本 React 嵌套变得困难重重。</li></ul> <h3 id="更新后"><a href="#更新后" class="header-anchor">#</a> 更新后</h3> <ul><li><strong>在 React 17 中，React 将不再向 <code>document</code> 附加事件处理器。而会将事件处理器附加到渲染 React 树的根 DOM 容器中：</strong></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rootNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> rootNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>在 React 16 或更早版本中，React 会对大多数事件执行 <code>document.addEventListener()</code>。React 17 将会在底层调用 <code>rootNode.addEventListener()</code>。</li></ul> <p><img src="https://zh-hans.reactjs.org/static/bb4b10114882a50090b8ff61b3c4d0fd/1e088/react_17_delegation.png" alt="A diagram showing how React 17 attaches events to the roots rather than to the document"></p> <p>来源——<a href="https://zh-hans.reactjs.org/blog/2020/08/10/react-v17-rc.html" target="_blank" rel="noopener noreferrer">React 官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_2、去除了事件池"><a href="#_2、去除了事件池" class="header-anchor">#</a> 2、去除了事件池</h2> <h3 id="关于-react-中的合成事件的事件池"><a href="#关于-react-中的合成事件的事件池" class="header-anchor">#</a> 关于 React 中的合成事件的事件池</h3> <ul><li>在 React 17 之前，<code>合成事件对象</code> 会被放进一个叫 <code>事件池</code> 的地方统一管理。</li> <li>这样做的目的是能够实现 <code>事件对象</code> 的复用，进而提高性能。</li> <li>但是这样处理的话，每当事件处理函数执行完毕之后，对应的合成事件对象就会被<code>&quot;格式化&quot;</code>，为下一次复用做准备，这就意味着我们在事件处理函数执行完毕之后就拿不到事件对象了。如下这个例子（官方提供）</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// This won't work because the event object gets reused.</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Too late!</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>如果你在一个 DOM 元素上绑定上面这个事件处理函数，触发之后控制台会提示如下信息：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Warning<span class="token operator">:</span> This synthetic event is reused <span class="token keyword">for</span> performance reasons<span class="token punctuation">.</span>
If you<span class="token string">'re seeing this, you'</span>re accessing the property <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">target</span><span class="token template-punctuation string">`</span></span> on a released<span class="token operator">/</span>nullified synthetic event<span class="token punctuation">.</span>
This is <span class="token keyword">set</span> to <span class="token keyword">null</span><span class="token punctuation">.</span> If you must keep the original synthetic event around<span class="token punctuation">,</span> use <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">event.persist()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span>
See https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>fb<span class="token punctuation">.</span>me<span class="token operator">/</span>react<span class="token operator">-</span>event<span class="token operator">-</span>pooling <span class="token keyword">for</span> more information<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>根据这个提示信息能够看到解决方法：要想拿到目标事件对象，必须显式地告诉 React——我永远需要它，也就是调用 <code>e.persist()</code> 函数，像下面这样：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// This won't work because the event object gets reused.</span>
	event<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Too late!</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>React 17 拥抱了新时代的潮流，重新在研发体验和向下兼容性能之间做了选择，这一次，它选择了前者——<strong>放弃事件池，为每一个合成事件创建新的对象</strong>。因此在 React 17 中，我们不需要 e.persist()，也可以随时随地访问我们想要的事件对象。</li></ul> <h2 id="_3、useeffect-副作用清理时机的改动"><a href="#_3、useeffect-副作用清理时机的改动" class="header-anchor">#</a> 3、useEffect 副作用清理时机的改动</h2> <ul><li><p>React 16 中当组件被卸载时 useEffect 副作用中的清理函数是会同步执行的，对于大型应用程序来说，这不是理想选择，因为同步会减缓屏幕的过渡（例如，切换标签）。</p></li> <li><p><strong>在 React 17 中，副作用清理函数总会异步执行 —— 如果要卸载组件，则清理会在屏幕更新后运行。</strong></p> <p>这反映了副作用本身如何更紧密地运行。在极少数情况下，你可能希望依靠同步执行，可以改用 <code>useLayoutEffect</code>。</p></li></ul> <h2 id="_4、全新的-jsx-转换规则"><a href="#_4、全新的-jsx-转换规则" class="header-anchor">#</a> 4、全新的 JSX 转换规则</h2> <h3 id="react-16-之前的转换规则"><a href="#react-16-之前的转换规则" class="header-anchor">#</a> React 16 之前的转换规则</h3> <ul><li><p><code>React 17</code> 之前 <code>React</code> 中的 <code>jsx</code> 会被 <code>babel</code> 转换成 <code>React.createElement()</code> 的调用，在 <code>React.createElement()</code> 中对传入的参数进行一顿处理后，传入 <code>reactElement()</code> 并返回。</p></li> <li><p>例如，假设源代码如下：</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Hello World<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>旧的 JSX 转换会将上述代码变成普通的 JavaScript 代码：</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'Hello world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>在旧的转换规则下如果使用了 JSX，就必须在引入 <code>React</code>，因为 JSX 将被编译成 <code>React.createElement()</code>。</li></ul> <h3 id="react-17-的转换规则"><a href="#react-17-的转换规则" class="header-anchor">#</a> React 17 的转换规则</h3> <ul><li><p>React 17 在 React 的 package 中引入了两个新入口，这些入口只会被 Babel 和 TypeScript 等编译器使用。新的 JSX 转换<strong>不会将 JSX 转换为 <code>React.createElement</code></strong>，而是自动从 React 的 package 中引入新的入口函数并调用。</p></li> <li><p>例如，假设源代码如下：</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Hello World<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>下方是新 JSX 被转换编译后的结果：</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 由编译器引入（禁止自己引入！）</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> jsx <span class="token keyword">as</span> _jsx <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react/jsx-runtime'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">_jsx</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> children<span class="token operator">:</span> <span class="token string">'Hello world'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>注意，此时源代码<strong>无需引入 React</strong> 即可使用 JSX 了！ 当然了，如果要用到其他 React 中的导出还是需要引入 <code>React</code> 的。</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/jingjing20/edit/master/React/React 17 新特性.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">4/14/2021, 11:07:08 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/React/react hooks.html" class="prev">
        React Hooks
      </a></span> <span class="next"><a href="/Git/git基础.html">
        Git
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.904810b9.js" defer></script><script src="/assets/js/2.4ed7a71f.js" defer></script><script src="/assets/js/23.a9c07bef.js" defer></script>
  </body>
</html>
